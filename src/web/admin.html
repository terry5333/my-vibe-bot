<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç®¡ç†å“¡å¾Œå°</title>
  <style>
    :root{
      --bg1:#070a12; --bg2:#0b1220;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --a1:#22d3ee; --a2:#6366f1; --danger:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(99,102,241,.22), transparent 55%),
        radial-gradient(900px 650px at 80% 30%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial;
    }
    a{color:#a5b4fc;text-decoration:none}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .title{font-size:18px;font-weight:900}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);cursor:pointer}
    .tab.on{background:linear-gradient(135deg, rgba(34,211,238,.25), rgba(99,102,241,.22));}
    .layout{display:grid;grid-template-columns: 1fr; gap:12px}
    @media (min-width: 1100px){ .layout{grid-template-columns: 1fr 1fr 1fr;} }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      min-height: 240px;
      overflow:hidden;
    }
    h3{margin:0 0 10px 0; font-size:13px; color: rgba(255,255,255,.86)}
    .muted{color:var(--muted); font-size:12px; line-height:1.5}
    input,button,select{
      padding:10px 12px;border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    button{
      border:none; cursor:pointer; font-weight:900; color:#081018;
      background: linear-gradient(135deg,var(--a1),var(--a2));
    }
    .btn-danger{background: linear-gradient(135deg, var(--danger), #f43f5e); color:#120a0f;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    table{width:100%; border-collapse:collapse; overflow:hidden;border-radius: 14px;}
    th,td{padding:10px; border-bottom:1px solid rgba(255,255,255,.10); text-align:left; font-size:13px;}
    th{background: rgba(255,255,255,.06); font-size:12px; color: rgba(255,255,255,.82)}
    code{background: rgba(255,255,255,.08); padding:2px 6px; border-radius: 10px;}
    .avatar{width:34px;height:34px;border-radius:999px;border:1px solid rgba(255,255,255,.18);object-fit:cover}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px}
    .hidden{display:none}
    .split{display:grid;grid-template-columns: 1fr; gap:12px}
    @media (min-width: 1100px){ .split{grid-template-columns: 1fr 1fr;} }
    .events{max-height:260px; overflow:auto; border-radius:14px; border:1px solid rgba(255,255,255,.10); padding:8px; background:rgba(0,0,0,.18)}
    .evt{font-size:12px; color: rgba(255,255,255,.80); padding:6px 6px; border-bottom:1px dashed rgba(255,255,255,.10)}
    .evt:last-child{border-bottom:none}
  </style>
</head>
<body>
  <div class="top">
    <div class="title">ç®¡ç†å“¡å¾Œå°</div>
    <div class="tabs">
      <div class="tab on" data-page="dashboard">æ§åˆ¶å°</div>
      <div class="tab" data-page="history">æ­·å²æˆ°ç¸¾ï¼ˆ7å¤©ï¼‰</div>
      <div class="tab" data-page="settings">VIP / çµç®—</div>
      <a class="tab" href="/admin/logout">ç™»å‡º</a>
    </div>
  </div>

  <!-- DASHBOARD: ä¸‰å€ -->
  <div id="page-dashboard">
    <div class="layout">
      <div class="card">
        <h3>ğŸ“Š æ’è¡Œæ¦œï¼ˆTop 100ï¼‰</h3>
        <div class="muted">è®€å–ä¸­â€¦</div>
        <div id="lb"></div>
      </div>

      <div class="card">
        <h3>ğŸ‘¤ ç©å®¶ç©åˆ†ç®¡ç†</h3>
        <div class="row" style="margin-bottom:10px;">
          <input id="uSearch" placeholder="æœå°‹ userId / åç¨±" />
          <button id="uReload">é‡æ–°æ•´ç†</button>
        </div>
        <div id="users"></div>
      </div>

      <div class="card">
        <h3>ğŸ® æˆ¿é–“ç®¡ç†</h3>
        <div class="muted">å¯æŸ¥çœ‹æœ¬å±€ç´€éŒ„ï¼Œä¸¦å¼·åˆ¶é—œé–‰æˆ¿é–“ã€‚</div>
        <div id="rooms"></div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="page-history" class="hidden">
    <div class="split">
      <div class="card">
        <h3>ğŸ“œ è¿‘ 7 å¤©æˆ¿é–“åˆ—è¡¨</h3>
        <div id="days"></div>
        <div id="roomsByDay" style="margin-top:10px;"></div>
      </div>
      <div class="card">
        <h3>ğŸ§¾ æˆ¿é–“ç´€éŒ„</h3>
        <div class="muted">é¸ä¸€å€‹æˆ¿é–“å¾Œæœƒé¡¯ç¤ºç´€éŒ„</div>
        <div id="historyEvents" class="events" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="page-settings" class="hidden">
    <div class="split">
      <div class="card">
        <h3>ğŸ‘‘ VIP è¨­å®š</h3>
        <div class="row" style="margin-bottom:10px;">
          <span class="pill">å³æ™‚ç”Ÿæ•ˆ</span>
        </div>
        <div class="row">
          <label class="pill"><input id="vipEnabled" type="checkbox"> å•Ÿç”¨</label>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="vipGuild" placeholder="ä¼ºæœå™¨ID" />
          <input id="vipRole" placeholder="èº«åˆ†çµ„ID" />
          <input id="vipThreshold" placeholder="é–€æª»ç©åˆ†" />
          <button id="saveVip">ä¿å­˜</button>
        </div>
        <div class="muted" style="margin-top:10px;">Bot éœ€è¦ Manage Rolesï¼Œä¸” Bot èº«åˆ†çµ„å¿…é ˆé«˜æ–¼ VIP èº«åˆ†çµ„ã€‚</div>
      </div>

      <div class="card">
        <h3>ğŸ æ¯é€±çµç®—</h3>
        <div class="row">
          <label class="pill"><input id="wkEnabled" type="checkbox"> å•Ÿç”¨</label>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="wkTopN" placeholder="Top N" />
          <input id="wkReward" placeholder="æ¯äººçå‹µåˆ†æ•¸" />
          <button id="saveWk">ä¿å­˜</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="payout">ç™¼æ”¾æœ¬é€±çå‹µ</button>
          <button id="resetLock" class="btn-danger">é‡ç½®çµç®—é–</button>
        </div>

        <div class="events" id="wkLog" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function fmtTs(ts){
    if(!ts) return "";
    const d = new Date(ts);
    return d.toLocaleString();
  }

  async function jget(url){
    const r = await fetch(url, { credentials: "include" });
    if(r.status === 401){ location.href="/admin/login"; return null; }
    return r.json();
  }
  async function jpost(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify(body || {})
    });
    if(r.status === 401){ location.href="/admin/login"; return null; }
    return r.json();
  }

  // tabs
  document.querySelectorAll(".tab[data-page]").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab[data-page]").forEach(x=>x.classList.remove("on"));
      t.classList.add("on");

      const p = t.dataset.page;
      ["dashboard","history","settings"].forEach(k=>{
        document.getElementById("page-"+k).classList.toggle("hidden", k !== p);
      });

      if(p==="history") loadHistory();
      if(p==="settings") loadSettings();
    });
  });

  // Leaderboard
  async function loadLeaderboard(){
    const js = await jget("/api/leaderboard?limit=100");
    if(!js) return;
    const data = js.data || [];
    let html = "<table><tr><th>#</th><th>ç©å®¶</th><th>ç©åˆ†</th></tr>";
    data.forEach((x,i)=>{
      html += \`<tr><td>\${i+1}</td><td><code>\${x.userId}</code></td><td><b>\${x.points}</b></td></tr>\`;
    });
    html += "</table>";
    $("lb").innerHTML = html;
  }

  // Users (avatar + name + +/-)
  async function loadUsers(){
    const q = $("uSearch").value.trim();
    const js = await jget("/api/users" + (q ? ("?q="+encodeURIComponent(q)) : ""));
    if(!js) return;
    const data = js.data || [];
    let html = "<table><tr><th></th><th>åç¨±</th><th>UserID</th><th>ç©åˆ†</th><th>èª¿æ•´</th></tr>";
    data.slice(0,120).forEach(u=>{
      html += \`
      <tr>
        <td>\${u.avatar ? \`<img class="avatar" src="\${u.avatar}" />\` : ""}</td>
        <td><b>\${(u.name||"")}</b></td>
        <td><code>\${u.userId}</code></td>
        <td><b>\${u.points}</b></td>
        <td>
          <div class="row">
            <button onclick="adjust('\${u.userId}', 10)">+10</button>
            <button onclick="adjust('\${u.userId}', -10)" class="btn-danger">-10</button>
          </div>
        </td>
      </tr>\`;
    });
    html += "</table>";
    $("users").innerHTML = html;
  }

  async function adjust(userId, amount){
    const js = await jpost("/api/points/adjust", { userId, amount });
    if(!js) return;
    await loadUsers();
    await loadLeaderboard();
  }

  $("uReload").addEventListener("click", loadUsers);
  $("uSearch").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadUsers(); });

  // Rooms management + show records (from activeDb + live)
  function renderEvents(events){
    if(!events || !events.length) return "<div class='muted'>æ²’æœ‰ç´€éŒ„</div>";
    return events.map(e => \`<div class="evt">\${fmtTs(e.ts)} â€” \${JSON.stringify(e)}</div>\`).join("");
  }

  async function loadRooms(){
    const js = await jget("/api/rooms");
    if(!js) return;

    const live = js.live || { guess:[], counting:[], hl:[] };

    let html = "";

    // Guess
    html += "<div class='pill'>Guess</div>";
    if(!live.guess.length) html += "<div class='muted' style='margin:8px 0'>ç›®å‰æ²’æœ‰ Guess</div>";
    live.guess.forEach(r=>{
      html += \`
      <div style="margin:10px 0; padding:10px; border:1px solid rgba(255,255,255,.10); borde
